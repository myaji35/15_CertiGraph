<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50" data-controller="session-timeout">
  <%= render 'shared/navbar' %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- μ‚¬μ©μ μΈμ‚¬ -->
    <div class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-3">
        μ•λ…•ν•μ„Έμ”, <%= @user.name || @user.email.split('@').first %>λ‹! π‘‹
      </h1>
      <p class="text-xl text-gray-600">μ¤λλ„ ExamsGraphμ™€ ν•¨κ» ν•™μµμ„ μ‹μ‘ν•΄λ³΄μ„Έμ”.</p>
      <p class="text-sm text-gray-500 mt-2"><%= @user.email %></p>
    </div>

    <!-- λ€μ‹λ³΄λ“ ν†µκ³„ μΉ΄λ“ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
      <!-- ν•™μµ μ„ΈνΈ μΉ΄λ“ -->
      <div class="card card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="feature-icon feature-icon-blue">
            <span class="text-2xl">π“</span>
          </div>
          <span class="badge">μ „μ²΄</span>
        </div>
        <h3 class="text-3xl font-bold text-gray-900 mb-1"><%= current_user.study_sets.count %></h3>
        <p class="text-sm text-gray-600">ν•™μµ μ„ΈνΈ</p>
      </div>

      <!-- ν•™μµ μ§„ν–‰λ¥  μΉ΄λ“ -->
      <div class="card card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="feature-icon feature-icon-green">
            <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </div>
          <span class="badge">μ΄λ² μ£Ό</span>
        </div>
        <h3 class="text-3xl font-bold text-gray-900 mb-1"><%= @analytics[:completed_tests] %></h3>
        <p class="text-sm text-gray-600">μ™„λ£ν• μ‹ν—</p>
      </div>

      <!-- μ •λ‹µλ¥  μΉ΄λ“ -->
      <div class="card card-hover">
        <div class="flex items-center justify-between mb-4">
          <div class="feature-icon feature-icon-purple">
            <span class="text-2xl">π―</span>
          </div>
          <span class="badge">ν‰κ· </span>
        </div>
        <h3 class="text-3xl font-bold text-gray-900 mb-1"><%= @analytics[:average_score].round %>%</h3>
        <p class="text-sm text-gray-600">μ •λ‹µλ¥ </p>
      </div>
    </div>

    <!-- λΉ λ¥Έ μ‘μ—… μ„Ήμ… -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">λΉ λ¥Έ μ‘μ—…</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <%= link_to new_study_set_path, class: "card border-2 border-dashed border-gray-300 hover:border-blue-500 hover:bg-blue-50 transition-all group cursor-pointer" do %>
          <div class="flex flex-col items-center">
            <span class="text-4xl mb-3">β•</span>
            <span class="text-gray-700 font-semibold group-hover:text-blue-600">μƒ ν•™μµ μ„ΈνΈ λ§λ“¤κΈ°</span>
          </div>
        <% end %>

        <%= link_to study_sets_path, class: "card border-2 border-dashed border-gray-300 hover:border-green-500 hover:bg-green-50 transition-all group cursor-pointer" do %>
          <div class="flex flex-col items-center">
            <span class="text-4xl mb-3">π“</span>
            <span class="text-gray-700 font-semibold group-hover:text-green-600">λ‚΄ ν•™μµ μ„ΈνΈ</span>
          </div>
        <% end %>

        <%= link_to "#", class: "card border-2 border-dashed border-gray-300 hover:border-purple-500 hover:bg-purple-50 transition-all group cursor-pointer" do %>
          <div class="flex flex-col items-center">
            <span class="text-4xl mb-3">π”</span>
            <span class="text-gray-700 font-semibold group-hover:text-purple-600">κ³µκ° λ¬Έμ μ§‘ νƒμƒ‰</span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- μµκ·Ό ν•™μµ μ„ΈνΈ -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">μµκ·Ό ν•™μµ μ„ΈνΈ</h2>
      <% if @recent_study_sets.any? %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <% @recent_study_sets.each do |study_set| %>
            <div class="card card-hover">
              <h3 class="card-title text-lg"><%= study_set.title %></h3>
              <p class="text-sm text-gray-600 mb-4 line-clamp-2"><%= study_set.description %></p>
              <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                <span class="text-xs text-gray-500">
                  <%= study_set.created_at.strftime("%Y.%m.%d") %>
                </span>
                <%= link_to "ν•™μµν•κΈ° β†’", study_set_path(study_set),
                    class: "text-primary-blue hover:text-primary-blue-hover text-sm font-semibold transition" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="card text-center p-12">
          <span class="text-6xl mb-4 block">π“</span>
          <h3 class="text-xl font-bold text-gray-900 mb-2">μ•„μ§ ν•™μµ μ„ΈνΈκ°€ μ—†μµλ‹λ‹¤</h3>
          <p class="text-gray-600 mb-6">μ²« ν•™μµ μ„ΈνΈλ¥Ό λ§λ“¤μ–΄ ν•™μµμ„ μ‹μ‘ν•΄λ³΄μ„Έμ”!</p>
          <%= link_to "μ²« ν•™μµ μ„ΈνΈ λ§λ“¤κΈ°", new_study_set_path,
              class: "btn btn-primary btn-lg" %>
        </div>
      <% end %>
    </div>

    <!-- Charts Section - Only show if there's data -->
    <% if @analytics[:completed_tests] > 0 %>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Weekly Performance Chart -->
        <div class="card">
          <h2 class="card-title">μ£Όκ°„ ν•™μµ μ„±κ³Ό</h2>
          <canvas id="weeklyPerformanceChart" height="250"></canvas>
        </div>

        <!-- Mastery Distribution Chart -->
        <div class="card">
          <h2 class="card-title">κ°λ… μ™λ‹¬ ν„ν™©</h2>
          <canvas id="masteryDistributionChart" height="250"></canvas>
        </div>
      </div>
    <% end %>

    <!-- ν•™μµ ν μ„Ήμ… -->
    <div class="card bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200">
      <div class="flex items-start">
        <span class="text-3xl mr-4">π’΅</span>
        <div>
          <h3 class="font-bold text-gray-900 mb-2 text-lg">μ¤λμ ν•™μµ ν</h3>
          <p class="text-gray-700 leading-relaxed">
            ExamsGraphμ μ§€μ‹ κ·Έλν”„ κΈ°λ¥μ„ ν™μ©ν•λ©΄ μ•½μ  λ¶„μ„μ„ ν†µν•΄ ν¨μ¨μ μΈ ν•™μµμ΄ κ°€λ¥ν•©λ‹λ‹¤.
            PDFλ¥Ό μ—…λ΅λ“ν•κ³  AI λ¶„μ„μ„ μ‹μ‘ν•΄λ³΄μ„Έμ”!
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load weekly statistics
    fetch('/dashboard/statistics?period=week')
      .then(response => response.json())
      .then(data => {
        const dailyData = data.data.daily_breakdown;
        const labels = dailyData.map(d => new Date(d.date).toLocaleDateString('ko-KR', { weekday: 'short' }));
        const scores = dailyData.map(d => d.average_score);

        const ctx = document.getElementById('weeklyPerformanceChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'ν‰κ·  μ μ',
              data: scores,
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      })
      .catch(error => console.error('Error loading weekly stats:', error));

    // Load mastery distribution
    const masteryData = <%= raw @analytics[:mastery_overview].to_json %>;
    const masteryCtx = document.getElementById('masteryDistributionChart').getContext('2d');
    new Chart(masteryCtx, {
      type: 'doughnut',
      data: {
        labels: ['μ™λ‹¬λ¨', 'ν•™μµ μ¤‘', 'μ•½ν•¨', 'λ―Έν•™μµ'],
        datasets: [{
          data: [
            masteryData.mastered,
            masteryData.learning,
            masteryData.weak,
            masteryData.untested
          ],
          backgroundColor: [
            'rgb(34, 197, 94)',
            'rgb(59, 130, 246)',
            'rgb(239, 68, 68)',
            'rgb(156, 163, 175)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  });
</script>