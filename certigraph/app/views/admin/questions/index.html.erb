<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-900">문제 관리</h1>
    <div class="flex gap-4">
      <%= link_to '새 문제 추가', new_admin_question_path(study_set_id: params[:study_set_id]), class: 'btn btn-primary' %>
      <!-- CSV Import - Admin Only (Hidden from regular users) -->
      <% if current_user&.super_admin? %>
        <%= link_to 'CSV 가져오기', '#', data: { action: 'click->bulk-import#open' }, class: 'btn btn-secondary' %>
      <% end %>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="text-sm text-gray-600">전체 문제</div>
      <div class="text-3xl font-bold text-blue-600"><%= @total_count %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <div class="text-sm text-gray-600">난이도 상</div>
      <div class="text-3xl font-bold text-red-600"><%= Question.by_difficulty(5).count %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <div class="text-sm text-gray-600">난이도 중</div>
      <div class="text-3xl font-bold text-yellow-600"><%= Question.by_difficulty(3).count %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <div class="text-sm text-gray-600">난이도 하</div>
      <div class="text-3xl font-bold text-green-600"><%= Question.by_difficulty(1).count %></div>
    </div>
  </div>

  <!-- Questions Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">문제</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학습 세트</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">난이도</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">주제</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작업</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @questions.each do |question| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= question.id %></td>
            <td class="px-6 py-4 text-sm text-gray-900">
              <%= truncate(question.content, length: 100) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              <%= question.study_set.name %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                <%= difficulty_badge_class(question.difficulty) %>">
                <%= question.difficulty || 'N/A' %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
              <%= question.topic || '-' %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <%= link_to '보기', admin_question_path(question), class: 'text-blue-600 hover:text-blue-900 mr-3' %>
              <%= link_to '수정', edit_admin_question_path(question), class: 'text-yellow-600 hover:text-yellow-900 mr-3' %>
              <%= button_to '삭제', admin_question_path(question), method: :delete, 
                  data: { confirm: '정말 삭제하시겠습니까?' }, 
                  class: 'text-red-600 hover:text-red-900' %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-6">
    <%= paginate @questions %>
  </div>
</div>

<!-- Bulk Import Modal (Super Admin Only) -->
<% if current_user&.super_admin? %>
  <div id="bulk-import-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4">CSV 파일 가져오기 (관리자 전용)</h3>
        <%= form_with url: bulk_import_admin_questions_path, multipart: true, class: 'space-y-4' do |f| %>
          <div>
            <%= f.label :file, 'CSV 파일 선택', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= f.file_field :file, accept: '.csv', class: 'block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer' %>
            <p class="mt-1 text-sm text-gray-500">
              형식: study_set_id, content, question_type, difficulty, topic, options, correct_answer
            </p>
            <p class="mt-2 text-xs text-red-600">
              ⚠️ 이 기능은 관리자 효율성 도구입니다. 사용자 PDF 업로드는 Phase 2에서 제공됩니다.
            </p>
          </div>
          <div class="flex justify-end gap-3">
            <button type="button" onclick="document.getElementById('bulk-import-modal').classList.add('hidden')" 
                    class="btn btn-secondary">
              취소
            </button>
            <%= f.submit '가져오기', class: 'btn btn-primary' %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <% content_for :javascript do %>
    <script>
      document.addEventListener('click', (e) => {
        if (e.target.matches('[data-action="click->bulk-import#open"]')) {
          e.preventDefault();
          document.getElementById('bulk-import-modal').classList.remove('hidden');
        }
      });
    </script>
  <% end %>
<% end %>
